syntax = "proto3";

import "rootsdk/types.proto";

message RoomState {
  string room_id = 1;
  string host_user_id = 2;
  string room_name = 12;
  string media_url = 3;
  bool playing = 4;
  double current_time_seconds = 5;
  double playback_rate = 6;
  uint64 updated_at_ms = 7;
  uint64 version = 8;
  repeated string participant_user_ids = 9;
  double duration_seconds = 10;
  string pending_host_user_id = 11;
  repeated string playlist_urls = 13;
  repeated string playlist_history_urls = 14;
  repeated string playlist_added_by_user_ids = 15;
  repeated string playlist_history_added_by_user_ids = 16;
  string current_media_added_by_user_id = 17;
  bool allow_viewer_queue_add = 18;
  string subtitle_label = 19;
  string subtitle_vtt_text = 20;
}

message GetRoomStateRequest {
  string room_id = 1;
}

message LeaveRoomRequest {
  string room_id = 1;
}

message GetRoomStateResponse {
  RoomState state = 1;
}

message SetHostRequest {
  string room_id = 1;
  string host_user_id = 2;
}

message SetMediaRequest {
  string room_id = 1;
  string url = 2;
}

message PlaylistMutationRequest {
  string room_id = 1;
  string url = 2;
}

message AdvanceQueueRequest {
  string room_id = 1;
  bool autoplay = 2;
}

message RemoveQueueItemRequest {
  string room_id = 1;
  uint32 index = 2;
}

message MoveQueueItemRequest {
  string room_id = 1;
  uint32 from_index = 2;
  uint32 to_index = 3;
}

message SetRoomNameRequest {
  string room_id = 1;
  string room_name = 2;
}

message SetViewerQueuePolicyRequest {
  string room_id = 1;
  bool allow_viewer_queue_add = 2;
}

message PlaybackRequest {
  string room_id = 1;
  double at_seconds = 2;
}

message SetRateRequest {
  string room_id = 1;
  double playback_rate = 2;
}

message SetDurationRequest {
  string room_id = 1;
  double duration_seconds = 2;
}

message RequestHostClaimRequest {
  string room_id = 1;
}

message DecideHostClaimRequest {
  string room_id = 1;
  string requester_user_id = 2;
  bool approve = 3;
}

message ListRoomsRequest {}

message RoomSummary {
  string room_id = 1;
  string room_name = 10;
  string preview_media_url = 11;
  string host_user_id = 2;
  string media_url = 3;
  bool playing = 4;
  double current_time_seconds = 5;
  double duration_seconds = 6;
  double progress_percent = 7;
  repeated string participant_user_ids = 8;
  uint64 version = 9;
}

message ListRoomsResponse {
  repeated RoomSummary rooms = 1;
}

message MutationResponse {
  bool accepted = 1;
  string reason = 2;
  RoomState state = 3;
}

message StateChangedEvent {
  string room_id = 1;
  string action = 2;
  string actor_user_id = 3;
  RoomState state = 4;
}

message SearchSubtitlesRequest {
  string query = 1;
  string language = 2;
  bool tvseries = 3;
  uint32 season = 4;
  uint32 episode = 5;
}

message SubtitleCandidate {
  string id = 1;
  string provider = 2;
  string name = 3;
  string download_url = 4;
  int32 score = 5;
}

message SearchSubtitlesResponse {
  repeated SubtitleCandidate items = 1;
  string error = 2;
}

message FetchSubtitleRequest {
  string download_url = 1;
}

message FetchSubtitleResponse {
  bool ok = 1;
  string name = 2;
  string vtt_text = 3;
  string error = 4;
}

message SetSubtitleRequest {
  string room_id = 1;
  string subtitle_label = 2;
  string subtitle_vtt_text = 3;
}

service CineLinkService {
  rpc ListRooms(ListRoomsRequest) returns (ListRoomsResponse);
  rpc GetRoomState(GetRoomStateRequest) returns (GetRoomStateResponse);
  rpc LeaveRoom(LeaveRoomRequest) returns (MutationResponse);
  rpc SetHost(SetHostRequest) returns (MutationResponse);
  rpc SetRoomName(SetRoomNameRequest) returns (MutationResponse);
  rpc SetViewerQueuePolicy(SetViewerQueuePolicyRequest) returns (MutationResponse);
  rpc RequestHostClaim(RequestHostClaimRequest) returns (MutationResponse);
  rpc DecideHostClaim(DecideHostClaimRequest) returns (MutationResponse);
  rpc SetMedia(SetMediaRequest) returns (MutationResponse);
  rpc AddQueueNext(PlaylistMutationRequest) returns (MutationResponse);
  rpc AddQueueLast(PlaylistMutationRequest) returns (MutationResponse);
  rpc AdvanceQueue(AdvanceQueueRequest) returns (MutationResponse);
  rpc PreviousQueue(AdvanceQueueRequest) returns (MutationResponse);
  rpc RemoveQueueItem(RemoveQueueItemRequest) returns (MutationResponse);
  rpc MoveQueueItem(MoveQueueItemRequest) returns (MutationResponse);
  rpc SetDuration(SetDurationRequest) returns (MutationResponse);
  rpc Play(PlaybackRequest) returns (MutationResponse);
  rpc Pause(PlaybackRequest) returns (MutationResponse);
  rpc Seek(PlaybackRequest) returns (MutationResponse);
  rpc SetRate(SetRateRequest) returns (MutationResponse);
  rpc SearchSubtitles(SearchSubtitlesRequest) returns (SearchSubtitlesResponse);
  rpc FetchSubtitle(FetchSubtitleRequest) returns (FetchSubtitleResponse);
  rpc SetSubtitle(SetSubtitleRequest) returns (MutationResponse);

  rpc BroadcastStateChanged(StateChangedEvent) returns (rootsdk.Void);
}
