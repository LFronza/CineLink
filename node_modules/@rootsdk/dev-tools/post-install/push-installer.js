#!/usr/bin/env node
const os = require('os');
const path = require('path');
const fs = require('fs');
const tar = require('tar');
const platform = os.platform();
const arch = os.arch();

const basePath = '../publish/bin';

let binaryPath;

let partialTarget = `appsdk-lite-console-${platform}-${arch}`;

if (platform === 'win32') {
  binaryPath = path.join(__dirname, basePath, partialTarget+'.tar.gz');
} 
else if(platform == 'darwin') {
  binaryPath = path.join(__dirname, basePath, partialTarget+'.tar.gz');
}
else {
	partialTarget += isAlpine()?'-musl':'-libc';
  binaryPath = path.join(__dirname, basePath, partialTarget+'.tar.gz');
}

if (!fs.existsSync(binaryPath)) {
  console.error(`CLI binary not found at ${binaryPath}`);
  console.error(`OS / arch not supported`);
}
else {
	console.log(`Uncompressing ${binaryPath}`);
	tar.x({
		cwd: "./publish/bin",
		file: binaryPath
	})
}

function isAlpine() {
	try {
		const osRelease = fs.readFileSync('/etc/os-release', 'utf8');
		return osRelease.includes('ID=alpine') || osRelease.includes('NAME="Alpine Linux"');
	} catch (error) {
		return false; // File might not exist or other error
	}
}

