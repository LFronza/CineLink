name: player-tests

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build-and-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build networking
        run: npm run build --workspace @cinelink/networking
      - name: Build server
        run: npm run build --workspace @cinelink/server
      - name: Build client
        run: npm run build --workspace @cinelink/client

  server-integration-tests:
    runs-on: ubuntu-latest
    needs: build-and-unit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
      - name: Build all
        run: npm run build
      - name: Generate media fixtures
        run: npm run test:fixtures
      - name: Start server
        run: |
          mkdir -p tests/artifacts
          npm run server --workspace @cinelink/server > tests/artifacts/server.log 2>&1 &
          echo $! > tests/artifacts/server.pid
          sleep 10
      - name: Run API playback tests
        run: npm run test:player:api
      - name: Upload API artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-artifacts
          path: tests/artifacts/
      - name: Stop server
        if: always()
        run: |
          if [ -f tests/artifacts/server.pid ]; then kill $(cat tests/artifacts/server.pid) || true; fi

  client-e2e-playwright:
    runs-on: ubuntu-latest
    needs: server-integration-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
      - name: Build all
        run: npm run build
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Generate media fixtures
        run: npm run test:fixtures
      - name: Start server
        run: |
          mkdir -p tests/artifacts
          npm run server --workspace @cinelink/server > tests/artifacts/server-e2e.log 2>&1 &
          echo $! > tests/artifacts/server-e2e.pid
          sleep 10
      - name: Start client
        run: |
          npm run client --workspace @cinelink/client -- --host 0.0.0.0 --port 5173 > tests/artifacts/client-e2e.log 2>&1 &
          echo $! > tests/artifacts/client-e2e.pid
          sleep 8
      - name: Run Playwright tests
        env:
          CINELINK_CLIENT_BASE_URL: http://127.0.0.1:5173
          CINELINK_TEST_BASE_URL: http://127.0.0.1:8099
        run: npm run test:player:e2e
      - name: Upload e2e artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            tests/artifacts/
            playwright-report/
            test-results/
      - name: Stop services
        if: always()
        run: |
          if [ -f tests/artifacts/client-e2e.pid ]; then kill $(cat tests/artifacts/client-e2e.pid) || true; fi
          if [ -f tests/artifacts/server-e2e.pid ]; then kill $(cat tests/artifacts/server-e2e.pid) || true; fi
